 {% include "header.html" %}

<script src="{{url_for('static',filename='js/jQueryRotate.js') }}"></script>

<script src="{{url_for('static',filename='OpenLayers-2.13.1/OpenLayers.js') }}"></script>

<!-- Leaflet plugin -->
<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.css" />
<script src="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.js"></script>
<script src="{{url_for('static',filename='OpenLayers-2.13.1/plugins/leaflet.rotatedMarker.js') }}"></script>


<script>
    var boatMarker;
    $(function() {
        
    $( "#slider" ).slider({
        min:0,
        max:359,
        value:0,
        slide: function( event, ui ) {
            $('.angleviewer').html(ui.value + '&deg;');
            $('#boatimage').rotate(ui.value);
            rotateMapBoat(ui.value);
        },
        change: function(event, ui){
            $('.angleviewer').html(ui.value + '&deg;');
            console.log('New course : ' + ui.value);
            
            //Let's send the new course to the server to save it
            $.ajax({
                url: '/api/race/{{currentrace.id}}/updateboat',
                type: 'post',
                data: "course=" + ui.value ,
                success: function(data) {
                            console.log("Success with post ! : " + data);
                            if(data != 'ok')
                            {
                                console.log("Error !");
                                alert("Unknown error...");
                            }
                            else
                            {
                              //Do something... 
                            }
                        }
            });
        }
    });
    
    $( "#slider" ).slider("value", {{boatinfo.course}});
    $('#boatimage').rotate({{boatinfo.course}});
    
    
    
    //Map setup
    var lon            = {{boatinfo.longitude}};
    var lat            = {{boatinfo.latitude}};
    
    
    var zoom           = 12;
    
    $('#longitude').html(lon);
    $('#latitude').html(lat);
   
    /*var size = new OpenLayers.Size(21,25);
    var offset = new OpenLayers.Pixel(-(size.w/2), -size.h);
    var boatIcon = new OpenLayers.Icon('{{url_for('static',filename='images/boaticon.png') }}',size,offset); 
    
    var fromProjection = new OpenLayers.Projection("EPSG:4326");   // Transform from WGS 1984
    var toProjection   = new OpenLayers.Projection("EPSG:900913"); // to Spherical Mercator Projection
    var position       = new OpenLayers.LonLat(lon, lat);
    console.log("Position of marker before transform : " + position);
    position = position.transform( fromProjection, toProjection);

    map = new OpenLayers.Map("demoMap");
    var mapnik         = new OpenLayers.Layer.OSM();
    map.addLayer(mapnik);

    var markers = new OpenLayers.Layer.Markers( "Markers" );
    map.addLayer(markers);
    
    var boatMarker = new OpenLayers.Marker(position,boatIcon.clone());
    markers.addMarker(boatMarker);

    map.setCenter(position, zoom);
    
    console.log('Position of marker : ' + markers.markers[0].lonlat);*/
    
    var map = L.map('demoMap').setView([lat, lon], 13);

    L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
        attribution: ''
    }).addTo(map);

    boatMarker = L.marker([lat, lon]).addTo(map).setRotationAngle({{boatinfo.course}});
    
  });

  function rotateMapBoat(angle)
  {
      boatMarker.setRotationAngle(angle);
  }
</script>




<style type='text/css'>
    .angleviewer {
        margin: 30px 0;
        font-size: 20px;
    }
</style>

</head>

<body>
    <div class="container">

        <h1>{{ currentrace.name }}</h1>
        <div class="row">
            <div class="col-md-3">
                <p class="lead">Current position : </p>
                <p>Longitude : <span id="longitude"></span></p>
                <p>Latitude : <span id="latitude"></span></p>
                <p class="lead">Cap</p>
                <img id="boatimage" src="{{url_for('static',filename='images/boat.png') }}" class="img-responsive" />
                <div id="slider"></div>
                <div class="angleviewer">
                </div>

            </div>
            <div class="col-md-9">
                <h2>Map</h2>
                <div id="demoMap" style="height:600px"></div>

            </div>
        </div>

    </div>
    <!-- /.container -->

</body>

</html>